# マルウェア(malware)
悪意あるソフトウェアの総称

* ワーム ; 自己増殖する
* スパイウェア ; 情報収集を主な目的とする
* ランサムウェア(ransomware) ; ファイルを暗号化して身代金を要求する

# WannaCry
* Wdinwosを標的とするワーム型ランサムウェア(2017/4～ 150カ国 23万台以上に感染) by Wikipedia
* マイクロソフトによるWindows Xp向け特別パッチ
* ビットコインを要求
    * 支払っても解除されないらしい
* キルスイッチ
    * 特定のドメインにアクセスできると活動を停止する機能があった

# [三井物産セキュアディレクション 「WannaCry 2.0」の内部構造を紐解く](https://www.mbsd.jp/blog/20170518.html)

## ファイルの構造
* ドロッパー1
    * SMBの脆弱性を利用して拡散
    * リソースセクションに別のexe(ドロッパー2)が埋め込まれている
    * 実行されるとそのexeをサービスに登録する
* ドロッパー2(tasksche.exe)
    * 各種データをリソースセクションに保持
    * 各国の言語で書かれた脅迫文
    * @WannaDecryptor@.exe(暗号化本体)の名前を変更してコピー
    * taskse.exe ; 上記exeを起動するためのexe
    * 全ユーザにNTFSアクセス権のフルコントロールを与える

## セッション0の分離(Vista以降の機能)
* システムサービスはセッション0専用
    * セッション0ではUIを表示できない
* ユーザはセッション1以降を利用

ドロッパー1から直接UIを表示できないのでいったんtaskse.exeを経由して実行

# SMBの脆弱性MS17-010
* サーバがあるリクエストを処理するときにサイズ計算のオーバーフローが発生
* kernelコードを上書きして任意コード実行
* EternalBlue
    * NSAが(2008～2010年頃?)開発していた(2010年頃?)攻撃ツール(Fuzzbunch)の機能の一つ
* DoublePulsar
    * SMBを用いて通信を行うバックドア
    * EternalBlueがDoublePulsarを送り込む
* WannaCry 2.0がこれを利用
    * DoublePulsarを用いてWannaCryを感染させる cf. [WannaCry 2.0（＋亜種)におけるワーム活動の詳細と残存するDoublePulsarについて](https://www.mbsd.jp/blog/20170629.html)
    * launcher.dllをxor暗号化して転送し、復号してからメモリ上でlsass.exeにインジェクション


## 亜種
* [WannaCryのキルスイッチに見えた2次攻撃者の影](https://www.mbsd.jp/blog/20170607.html)
* キルスイッチが無効化されたもの
    * バイナリパッチを当てたと思われる
* ランサムウェア(暗号化機能)が無効化されたもの
    * 拡散を狙った?
    * 捜査を攪乱?

# [Olympic Destroyerの内部構造を紐解く](https://www.mbsd.jp/blog/20180215.html)
* 2018年冬季オリンピックを妨害するマルウェア
* 感染するとログイン情報を収集し, 自身を複製した後システムを破壊させてシャットダウン
* 管理者権限で動作すること前提

## 複数のexeの集合体
* [PsExec](https://technet.microsoft.com/ja-jp/sysinternals/bb897553.aspx) ; リモートから任意のプログラムを実行するMicrosoft製コマンドラインツール
     * PsExecを難読化して保持
* パスワードダンプツール
* ブラウザのパスワードダンプツール
* ワーム・システム破壊ツール

### 挙動
* システムの情報を収集した後ネットワークにつながる端末一覧を取得
* PsSexeでリモート先に自身をコピーして実行
* システム破壊
    * システムの復元・バックアップ・スタートアップ修復の削除
    * イベントログの削除
    * 全サービスの無効化
    * ファイルの一部を0で上書き
    * シャットダウン

### 自分自身の削除
* notepadを起動してコードインジェクション
* そのプロセスから自身のexeを削除
* notepadを終了

### 情報の埋め込み
* 収集した情報は自分のプログラムの中に取り込む
